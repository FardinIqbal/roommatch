<%# subscribe current_user to a unique stream shared with the match %>
<%= turbo_stream_from [current_user, @match] %>

<div class="max-w-2xl mx-auto mt-10 p-6 bg-white shadow rounded-lg flex flex-col h-[70vh]">
  <h2 class="text-xl font-semibold mb-4 text-center">Chat with <%= @match.name %></h2>

  <!-- message history -->
  <div id="messages" class="flex-1 overflow-y-auto space-y-4 mb-4 px-2">
    <%= render partial: "messages/message",
               collection: @messages,
               as: :message,
               locals: { local_user: current_user } %>
  </div>

  <!-- composer -->
  <%= form_with model: @new_message,
                url:   user_messages_path(@match),
                data:  { controller: "message-form",
                         action: "turbo:submit-end->message-form#clear" },
                class: "flex gap-2" do |f| %>
    <%= f.text_field :body,
                     placeholder: "Type your messageâ€¦",
                     class: "flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring",
                     autocomplete: "off" %>
    <%= f.submit "Send",
                 class: "bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600" %>
  <% end %>
</div>

<script>
    // auto-scroll to newest
    const scroller = document.getElementById("messages");
    if (scroller) scroller.scrollTop = scroller.scrollHeight;
</script>
